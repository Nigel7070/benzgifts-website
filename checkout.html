<script>
    // **** PASTE YOUR GOOGLE SCRIPT WEB APP URL HERE ****
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/a/macros/moe-dl.edu.my/s/AKfycbxKvjsXBisrqVe00NY64kyBOKM1JLkeE6VT2JdaGsRUWLtalTLWDJZyfwibjeLrpIhe/exec';

    let cart = [];

    // This function runs when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        cart = JSON.parse(localStorage.getItem('benzgifts_cart') || '[]');
        
        if (cart.length === 0) {
            alert("Your cart is empty!");
            window.location.href = '/';
            return;
        }

        displayCheckoutItems();
    });

    function displayCheckoutItems() {
        const itemsContainer = document.getElementById('checkoutItems');
        const totalContainer = document.getElementById('checkoutTotal');
        let total = 0;

        itemsContainer.innerHTML = cart.map(item => {
            const subtotal = item.price * item.quantity;
            total += subtotal;
            return `
                <div class="summary-item">
                    <img src="${item.image}" alt="${item.name}">
                    <div class="item-details">
                        <strong>${item.name}</strong><br>
                        <small>${item.quantity} x ${item.color} / ${item.size}</small>
                    </div>
                    <div class="item-price">RM${subtotal.toFixed(2)}</div>
                </div>
            `;
        }).join('');

        totalContainer.textContent = `RM${total.toFixed(2)}`;
    }

    async function handleCheckout(event) {
        event.preventDefault();
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Placing Order...';

        const orderData = {
            name: document.getElementById('fullName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value,
            items: cart,
            total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)
        };

        try {
            // Send the data to your Google Apps Script
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8', // Required for Apps Script
                },
                body: JSON.stringify(orderData)
            });

            const result = await response.json();

            if (result.result !== 'success') {
                throw new Error(result.message || 'Failed to submit order.');
            }

            alert('Order placed successfully! Thank you for your purchase.');
            
            localStorage.removeItem('benzgifts_cart');
            window.location.href = '/';

        } catch (error) {
            console.error('Checkout Error:', error);
            alert(`Error placing order: ${error.message}`);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Place Order';
        }
    }
</script>
