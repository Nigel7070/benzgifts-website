<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - BenzGifts</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #c9a962;
            --accent: #f5f0e8;
            --background: #fafaf8;
            --text: #2d3436;
            --text-light: #636e72;
            --white: #ffffff;
            --border: #e8e4de;
            --success: #27ae60;
            --error: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            line-height: 1.7;
            color: var(--text);
        }

        h1,
        h2,
        h3,
        h4 {
            font-family: 'Playfair Display', Georgia, serif;
            font-weight: 600;
            line-height: 1.3;
        }

        .container {
            max-width: 1200px;
            margin: 2.5rem auto;
            padding: 0 2rem;
        }

        .back-btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: var(--white);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 2rem;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: #2d2d44;
        }

        .product-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            background: var(--white);
            padding: 2.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .product-images {
            position: relative;
        }

        .main-image {
            width: 100%;
            height: 500px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 1rem;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 4rem;
        }

        .main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        .color-swatches {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .color-swatch {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            overflow: hidden;
        }

        .color-swatch img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .color-swatch.active {
            border-color: var(--secondary);
            transform: scale(1.08);
        }

        .product-info h1 {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .product-price {
            font-size: 1.75rem;
            color: var(--secondary);
            font-weight: 700;
            margin-bottom: 2rem;
            font-family: 'Inter', sans-serif;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
            font-size: 0.95rem;
        }

        .form-group select {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            background: var(--white);
            transition: border-color 0.2s;
        }

        .form-group select:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .quantity-btn {
            width: 42px;
            height: 42px;
            border: 1px solid var(--border);
            background: var(--white);
            color: var(--primary);
            border-radius: 8px;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quantity-btn:hover {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .quantity-display {
            font-size: 1.35rem;
            font-weight: 600;
            min-width: 40px;
            text-align: center;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 150px;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: #2d2d44;
        }

        .btn-secondary {
            background: var(--success);
            color: var(--white);
        }

        .btn-secondary:hover {
            background: #219150;
        }

        .btn-cart {
            background: var(--secondary);
            color: var(--primary);
        }

        .btn-cart:hover {
            background: #d4b872;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .weight-info {
            margin: 1rem 0;
            padding: 1rem;
            background: var(--accent);
            border-radius: 8px;
            border-left: 3px solid var(--secondary);
        }

        .weight-info-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .weight-icon {
            font-size: 1.4rem;
        }

        .weight-label {
            font-weight: 600;
            color: var(--primary);
        }

        .weight-value {
            color: var(--secondary);
            font-weight: 700;
            font-size: 1.05rem;
        }

        .stock-status {
            display: inline-block;
            padding: 0.4rem 1rem;
            border-radius: 4px;
            font-weight: 600;
            margin: 1rem 0;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stock-status.in-stock {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }

        .stock-status.out-of-stock {
            background: rgba(231, 76, 60, 0.1);
            color: var(--error);
        }

        .alert {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-weight: 500;
        }

        .alert-success {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
            border: 1px solid rgba(39, 174, 96, 0.2);
        }

        .alert-error {
            background: rgba(231, 76, 60, 0.1);
            color: var(--error);
            border: 1px solid rgba(231, 76, 60, 0.2);
        }

        /* Floating Cart Button */
        .cart-float-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: var(--white);
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(26, 26, 46, 0.3);
            z-index: 999;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-float-btn:hover {
            transform: scale(1.08);
            background: #2d2d44;
        }

        .cart-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--secondary);
            color: var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(26, 26, 46, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: var(--white);
            margin: 4% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 560px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .close {
            color: var(--text-light);
            font-size: 28px;
            font-weight: 400;
            cursor: pointer;
            transition: color 0.2s;
            line-height: 1;
        }

        .close:hover {
            color: var(--primary);
        }

        .modal-body {
            padding: 2rem;
        }

        /* CART STYLES */
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: var(--accent);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .select-all-container {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .select-all-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--secondary);
        }

        .selection-info {
            color: var(--secondary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .cart-items {
            max-height: 380px;
            overflow-y: auto;
            margin: 1rem 0;
        }

        .cart-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            align-items: center;
            transition: background 0.2s;
        }

        .cart-item.selected {
            background: rgba(201, 169, 98, 0.08);
            border-left: 3px solid var(--secondary);
        }

        .cart-item-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
            accent-color: var(--secondary);
        }

        .cart-item-image {
            width: 72px;
            height: 72px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .cart-item-variant {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }

        .cart-item-price {
            color: var(--secondary);
            font-weight: 700;
            font-size: 0.95rem;
        }

        .cart-item-remove {
            background: transparent;
            color: var(--error);
            border: 1px solid var(--error);
            padding: 0.5rem 0.9rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .cart-item-remove:hover {
            background: var(--error);
            color: var(--white);
        }

        .cart-total {
            background: var(--accent);
            padding: 1.25rem 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: right;
        }

        .cart-total-label {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
        }

        .cart-total-amount {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            margin-left: 0.75rem;
            font-family: 'Inter', sans-serif;
        }

        .cart-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .cart-actions button {
            flex: 1;
            padding: 0.9rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            font-family: 'Inter', sans-serif;
        }

        .remove-selected-btn {
            background: transparent;
            color: var(--error);
            border: 1px solid var(--error);
        }

        .remove-selected-btn:hover:not(:disabled) {
            background: var(--error);
            color: var(--white);
        }

        .checkout-selected-btn {
            background: var(--primary);
            color: var(--white);
        }

        .checkout-selected-btn:hover:not(:disabled) {
            background: #2d2d44;
        }

        .cart-actions button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .empty-cart {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }

        .empty-cart-icon {
            font-size: 3.5rem;
            margin-bottom: 0.75rem;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .container {
                margin: 1.5rem auto;
                padding: 0 1rem;
            }

            .product-detail {
                grid-template-columns: 1fr;
                gap: 2rem;
                padding: 1.5rem;
            }

            .main-image {
                height: 350px;
            }

            .product-info h1 {
                font-size: 1.75rem;
            }

            .cart-float-btn {
                bottom: 20px;
                right: 20px;
                width: 54px;
                height: 54px;
                font-size: 20px;
            }

            .modal-content {
                width: 94%;
                margin: 10% auto;
                max-height: 80vh;
            }

            .cart-actions {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .quantity-selector {
                width: 100%;
                justify-content: space-between;
                background: var(--accent);
                padding: 0.5rem;
                border-radius: 8px;
            }

            .quantity-btn {
                background: var(--white);
                border-color: var(--border);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="index.html" class="back-btn">‚Üê Back to Shop</a>

        <div class="product-detail">
            <!-- Images Section -->
            <div class="product-images">
                <div class="main-image" id="mainImage">
                    <span>üé®</span>
                </div>
                <div class="color-swatches" id="colorSwatches"></div>
            </div>

            <!-- Info Section -->
            <div class="product-info">
                <h1 id="productName">Loading...</h1>

                <!-- Description -->
                <div id="productDescription" style="color: #666; margin: 1rem 0; line-height: 1.6; font-size: 1.05rem;">
                </div>

                <div class="product-price" id="productPrice">RM 0.00</div>

                <!-- Weight Info -->
                <div class="weight-info">
                    <div class="weight-info-content">
                        <span class="weight-icon">üì¶</span>
                        <span class="weight-label">Weight per item:</span>
                        <span class="weight-value" id="productWeight">180g</span>
                    </div>
                    <div style="color: #666; font-size: 0.85rem; margin-top: 0.3rem;">
                        Shipping costs are calculated based on total weight at checkout
                    </div>
                </div>

                <div class="stock-status in-stock" id="stockStatus">In Stock</div>

                <div class="alert alert-success" id="successMsg" style="display: none;"></div>
                <div class="alert alert-error" id="errorMsg" style="display: none;"></div>

                <div class="form-group">
                    <label for="colorSelect">Select Color</label>
                    <select id="colorSelect" onchange="updateColorSelection()">
                        <option value="">Choose a color...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sizeSelect">Select Size</label>
                    <select id="sizeSelect" onchange="updatePrice()">
                        <option value="">Choose a size...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Quantity</label>
                    <div class="quantity-selector">
                        <button class="quantity-btn" onclick="decreaseQuantity()">-</button>
                        <span class="quantity-display" id="quantity">1</span>
                        <button class="quantity-btn" onclick="increaseQuantity()">+</button>
                    </div>
                </div>

                <!-- Customization Note -->
                <div
                    style="background: #f8f9fa; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin: 1.5rem 0;">
                    <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">
                        <span style="color: var(--primary);">üí° Customization Available:</span>
                        Add this item to cart, then proceed to checkout to upload your design and customize colors using
                        our AI Studio.
                    </p>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-cart" id="addToCartBtn" onclick="addToCart()">
                        üõí Add to Cart
                    </button>
                    <button class="btn btn-primary" onclick="buyNow()">
                        ‚ö° Buy Now
                    </button>
                </div>

                <!-- Floating Cart Button -->
                <button class="cart-float-btn" onclick="openCart()">
                    üõí
                    <span class="cart-badge" id="cartBadge" style="display: none;">0</span>
                </button>

                <!-- CART MODAL WITH SELECTION -->
                <div id="cartModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>üõí Shopping Cart</h2>
                            <span class="close" onclick="closeCart()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <!-- Selection Header -->
                            <div id="cartHeader" class="cart-header" style="display: none;">
                                <div class="select-all-container">
                                    <input type="checkbox" id="selectAllCheckbox" class="select-all-checkbox"
                                        onchange="toggleSelectAll()">
                                    <label for="selectAllCheckbox" style="cursor: pointer; font-weight: 600;">
                                        Select All
                                    </label>
                                </div>
                                <div class="selection-info" id="selectionInfo">
                                    0 items selected
                                </div>
                            </div>

                            <!-- Cart Items -->
                            <div id="cartItems" class="cart-items">
                                <div class="empty-cart">
                                    <div class="empty-cart-icon">üõí</div>
                                    <p>Your cart is empty</p>
                                </div>
                            </div>

                            <!-- Total Section -->
                            <div class="cart-total" id="cartTotalSection" style="display: none;">
                                <span class="cart-total-label">Total (All Items):</span>
                                <span class="cart-total-amount" id="cartTotal">RM0.00</span>
                            </div>

                            <div class="cart-total" id="selectedTotalSection"
                                style="display: none; background: #e8f0ff;">
                                <span class="cart-total-label">Selected Items Total:</span>
                                <span class="cart-total-amount" id="selectedTotal" style="color: #667eea;">RM0.00</span>
                            </div>

                            <!-- Action Buttons -->
                            <div class="cart-actions" id="cartActions" style="display: none;">
                                <button class="remove-selected-btn" id="removeSelectedBtn" onclick="removeSelected()"
                                    disabled>
                                    üóëÔ∏è Remove Selected
                                </button>
                                <button class="checkout-selected-btn" id="checkoutSelectedBtn"
                                    onclick="checkoutSelected()" disabled>
                                    ‚úì Checkout Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    const SUPABASE_URL = 'https://oomvdejocpdtqcmeacii.supabase.co';
                    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vbXZkZWpvY3BkdHFjbWVhY2lpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MzA1NjksImV4cCI6MjA3NTUwNjU2OX0.0P_dEqRlvSUVJiCF_F0mboSenqvbp64ZV9islyvcF_E';

                    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                        auth: {
                            persistSession: true,
                            autoRefreshToken: true,
                            detectSessionInUrl: true
                        }
                    });

                    let currentProduct = null;
                    let quantity = 1;
                    let cart = [];
                    let currentUser = null;
                    let selectedItems = new Set();

                    document.addEventListener('DOMContentLoaded', () => {
                        loadProduct();
                        checkAuth();
                        updateCartBadge();
                        document.addEventListener('click', function (event) {
                            const userMenu = document.querySelector('.user-menu');
                            if (userMenu && !userMenu.contains(event.target)) {
                                closeUserMenu();
                            }
                        });
                    });

                    async function checkAuth() {
                        try {
                            const hashParams = new URLSearchParams(window.location.hash.substring(1));
                            if (hashParams.get('access_token')) {
                                const { data, error } = await supabaseClient.auth.getSession();
                                if (window.location.hash) {
                                    window.history.replaceState(null, '', window.location.pathname);
                                }
                            }

                            const { data: { session } } = await supabaseClient.auth.getSession();
                            if (session) {
                                currentUser = session.user;
                                updateAuthUI(true);
                                await loadCartFromDB();
                                await loadProfile();
                            } else {
                                updateAuthUI(false);
                            }
                        } catch (error) {
                            console.error('Error checking auth:', error);
                            updateAuthUI(false);
                        }
                    }

                    function updateAuthUI(isLoggedIn) {
                        const authSection = document.getElementById('authSection');
                        if (isLoggedIn && currentUser) {
                            authSection.innerHTML = `
                    <div class="user-menu">
                        <span class="user-email" id="userEmailBtn">${currentUser.email}</span>
                        <div class="dropdown-menu" id="userDropdown">
                            <div class="dropdown-item" onclick="window.location.href='index.html?profile=true'">Profile Settings</div>
                            <div class="dropdown-item" onclick="handleLogout()">Logout</div>
                        </div>
                    </div>
                `;

                            document.getElementById('userEmailBtn').addEventListener('click', (e) => {
                                e.stopPropagation();
                                toggleUserMenu();
                            });
                        } else {
                            authSection.innerHTML = `<button class="auth-btn" onclick="openAuthModal()">Login / Sign Up</button>`;
                        }
                    }

                    async function loadProfile() {
                        if (!currentUser) return;
                        try {
                            const { data, error } = await supabaseClient
                                .from('profiles')
                                .select('full_name, phone, address')
                                .eq('id', currentUser.id)
                                .single();
                            if (error && error.code !== 'PGRST116') throw error;
                            // No need to fill local inputs here as they don't exist in product.html
                        } catch (error) {
                            console.error('Error loading profile:', error);
                        }
                    }

                    function toggleUserMenu() {
                        document.getElementById('userDropdown').classList.toggle('active');
                    }

                    function closeUserMenu() {
                        const dropdown = document.getElementById('userDropdown');
                        if (dropdown) dropdown.classList.remove('active');
                    }

                    function openAuthModal() {
                        // Redirect to home with auth modal open or just alert for now
                        // But better to just redirect to index.html
                        window.location.href = 'index.html?login=true';
                    }

                    async function handleLogout() {
                        try {
                            if (currentUser) await saveCartToDB();
                            await supabaseClient.auth.signOut();
                            window.location.reload();
                        } catch (error) {
                            console.error('Logout error:', error);
                        }
                    }

                    async function loadCartFromDB() {
                        if (!currentUser) return;
                        try {
                            const { data, error } = await supabaseClient
                                .from('profiles')
                                .select('cart')
                                .eq('id', currentUser.id)
                                .single();
                            if (error) throw error;
                            if (data && data.cart) {
                                const localCart = JSON.parse(localStorage.getItem('benzgifts_cart') || '[]');
                                const dbCart = Array.isArray(data.cart) ? data.cart : [];

                                // Simple merge: prefer local if more recent/exists, but this is a simplified version
                                if (localCart.length > 0) {
                                    cart = localCart;
                                    await saveCartToDB();
                                } else {
                                    cart = dbCart;
                                    localStorage.setItem('benzgifts_cart', JSON.stringify(cart));
                                }
                                updateCartBadge();
                            }
                        } catch (error) {
                            console.error('Error loading cart from DB:', error);
                        }
                    }

                    async function saveCartToDB() {
                        if (!currentUser) return;
                        if (!Array.isArray(cart)) cart = [];
                        try {
                            const { error } = await supabaseClient
                                .from('profiles')
                                .update({ cart: cart })
                                .eq('id', currentUser.id);
                            if (error) throw error;
                        } catch (error) {
                            console.error('Error saving cart to DB:', error);
                        }
                    }

                    async function loadProduct() {
                        const urlParams = new URLSearchParams(window.location.search);
                        const productId = urlParams.get('id');

                        if (!productId) {
                            alert('Product not found!');
                            window.location.href = 'index.html';
                            return;
                        }

                        try {
                            const { data, error } = await supabaseClient
                                .from('products')
                                .select('*')
                                .eq('id', productId)
                                .single();

                            if (error) throw error;

                            currentProduct = data;
                            displayProduct(data);
                        } catch (error) {
                            console.error('Error loading product:', error);
                            alert('Error loading product');
                        }
                    }

                    function displayProduct(product) {
                        document.getElementById('productName').textContent = product.name || 'Unnamed Product';
                        document.getElementById('productDescription').textContent = product.description || '';
                        document.getElementById('productWeight').textContent = (product.weight_grams || 180) + 'g';

                        // Display colors
                        if (product.colors && Array.isArray(product.colors) && product.colors.length > 0) {
                            const swatchesHTML = product.colors.map((color, index) => `
                    <div class="color-swatch ${index === 0 ? 'active' : ''}" 
                         data-color="${color.name}" 
                         data-image="${color.image}"
                         onclick="selectColor('${color.name}', '${color.image}', this)">
                        <img src="${color.image}" alt="${color.name}">
                    </div>
                `).join('');
                            document.getElementById('colorSwatches').innerHTML = swatchesHTML;

                            const colorSelect = document.getElementById('colorSelect');
                            colorSelect.innerHTML = '<option value="">Choose a color...</option>' +
                                product.colors.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

                            // Set first color as selected
                            selectColor(product.colors[0].name, product.colors[0].image, document.querySelector('.color-swatch'));
                            colorSelect.value = product.colors[0].name;
                        }

                        // Display sizes
                        if (product.sizes && Array.isArray(product.sizes) && product.sizes.length > 0) {
                            const sizeSelect = document.getElementById('sizeSelect');
                            sizeSelect.innerHTML = '<option value="">Choose a size...</option>' +
                                product.sizes.map(s => `<option value="${s}">${s}</option>`).join('');
                        }

                        // Display first variant price
                        if (product.variants && Array.isArray(product.variants) && product.variants.length > 0) {
                            const firstPrice = product.variants[0].price || 0;
                            document.getElementById('productPrice').textContent = `RM ${firstPrice.toFixed(2)}`;
                        }

                        updateStockStatus();
                    }

                    function selectColor(colorName, imageUrl, element) {
                        document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
                        if (element) element.classList.add('active');

                        const mainImage = document.getElementById('mainImage');
                        mainImage.innerHTML = `<img src="${imageUrl}" alt="${colorName}">`;

                        document.getElementById('colorSelect').value = colorName;
                        updatePrice();
                    }

                    function updateColorSelection() {
                        const colorName = document.getElementById('colorSelect').value;
                        if (!colorName || !currentProduct.colors) return;

                        const color = currentProduct.colors.find(c => c.name === colorName);
                        if (color) {
                            const swatch = document.querySelector(`[data-color="${colorName}"]`);
                            selectColor(colorName, color.image, swatch);
                        }
                    }

                    function updatePrice() {
                        const color = document.getElementById('colorSelect').value;
                        const size = document.getElementById('sizeSelect').value;

                        if (!color || !size || !currentProduct.variants) return;

                        const variant = currentProduct.variants.find(v => v.color === color && v.size === size);
                        if (variant) {
                            document.getElementById('productPrice').textContent = `RM ${(variant.price * quantity).toFixed(2)}`;
                            updateStockStatus();
                        }
                    }

                    function updateStockStatus() {
                        const color = document.getElementById('colorSelect').value;
                        const size = document.getElementById('sizeSelect').value;

                        if (!color || !size || !currentProduct.variants) return;

                        const variant = currentProduct.variants.find(v => v.color === color && v.size === size);
                        const stockStatus = document.getElementById('stockStatus');

                        if (variant && variant.stock > 0) {
                            stockStatus.className = 'stock-status in-stock';
                            stockStatus.textContent = `In Stock (${variant.stock} available)`;
                        } else {
                            stockStatus.className = 'stock-status out-of-stock';
                            stockStatus.textContent = 'Out of Stock';
                        }
                    }

                    function increaseQuantity() {
                        quantity++;
                        document.getElementById('quantity').textContent = quantity;
                        updatePrice();
                    }

                    function decreaseQuantity() {
                        if (quantity > 1) {
                            quantity--;
                            document.getElementById('quantity').textContent = quantity;
                            updatePrice();
                        }
                    }

                    function addToCart() {
                        if (!currentProduct) return;

                        const color = document.getElementById('colorSelect').value;
                        const size = document.getElementById('sizeSelect').value;

                        if (!color || !size) {
                            showError('Please select both color and size');
                            return;
                        }

                        const variant = currentProduct.variants.find(v => v.color === color && v.size === size);
                        if (!variant) {
                            showError('Selected variant not found');
                            return;
                        }

                        if (variant.stock < quantity) {
                            showError('Not enough stock available');
                            return;
                        }

                        cart = JSON.parse(localStorage.getItem('benzgifts_cart') || '[]');
                        if (!Array.isArray(cart)) cart = [];

                        const existingIndex = cart.findIndex(item =>
                            item.product_id === currentProduct.id &&
                            item.color === color &&
                            item.size === size
                        );

                        const cartItem = {
                            product_id: currentProduct.id,
                            name: currentProduct.name,
                            image: document.querySelector('.color-swatch.active img').src,
                            color: color,
                            size: size,
                            price: variant.price,
                            quantity: quantity
                        };

                        if (existingIndex >= 0) {
                            cart[existingIndex].quantity += quantity;
                        } else {
                            cart.push(cartItem);
                        }

                        localStorage.setItem('benzgifts_cart', JSON.stringify(cart));
                        if (currentUser) saveCartToDB();

                        showSuccess('‚úÖ Added to cart successfully!');
                        updateCartBadge();
                    }

                    function buyNow() {
                        if (!currentProduct) return;

                        const color = document.getElementById('colorSelect').value;
                        const size = document.getElementById('sizeSelect').value;

                        if (!color || !size) {
                            showError('Please select both color and size');
                            return;
                        }

                        const variant = currentProduct.variants.find(v => v.color === color && v.size === size);
                        if (!variant) {
                            showError('Selected variant not found');
                            return;
                        }

                        const item = {
                            product_id: currentProduct.id,
                            name: currentProduct.name,
                            image: document.querySelector('.color-swatch.active img').src,
                            color: color,
                            size: size,
                            price: variant.price,
                            quantity: quantity,
                            weight_grams: currentProduct.weight_grams || 180
                        };

                        localStorage.setItem('benzgifts_buynow', JSON.stringify(item));
                        window.location.href = 'checkout.html?buynow=true';
                    }

                    function closeCart() {
                        document.getElementById('cartModal').style.display = 'none';
                    }

                    window.onclick = function (event) {
                        const modal = document.getElementById('cartModal');
                        if (event.target === modal) {
                            closeCart();
                        }
                    }

                    function showSuccess(message) {
                        const el = document.getElementById('successMsg');
                        el.textContent = message;
                        el.style.display = 'block';
                        document.getElementById('errorMsg').style.display = 'none';
                    }

                    function showError(message) {
                        const el = document.getElementById('errorMsg');
                        el.textContent = message;
                        el.style.display = 'block';
                        document.getElementById('successMsg').style.display = 'none';
                    }

                    // CART WITH SELECTION FUNCTIONS
                    function openCart() {
                        const modal = document.getElementById('cartModal');
                        const cartItemsContainer = document.getElementById('cartItems');

                        cart = JSON.parse(localStorage.getItem('benzgifts_cart') || '[]');
                        if (!Array.isArray(cart)) cart = [];

                        selectedItems.clear();

                        if (cart.length === 0) {
                            cartItemsContainer.innerHTML = `
                    <div class="empty-cart">
                        <div class="empty-cart-icon">üõí</div>
                        <p>Your cart is empty</p>
                    </div>
                `;
                            document.getElementById('cartHeader').style.display = 'none';
                            document.getElementById('cartTotalSection').style.display = 'none';
                            document.getElementById('selectedTotalSection').style.display = 'none';
                            document.getElementById('cartActions').style.display = 'none';
                        } else {
                            document.getElementById('cartHeader').style.display = 'flex';
                            document.getElementById('cartActions').style.display = 'flex';

                            let total = 0;
                            cartItemsContainer.innerHTML = cart.map((item, index) => {
                                const price = item.price || 0;
                                const q = item.quantity || 1;
                                const name = item.name || 'Unknown Item';
                                const color = item.color || '';
                                const size = item.size || '';
                                const image = item.image || 'https://via.placeholder.com/80';
                                const subtotal = price * q;
                                total += subtotal;

                                return `
                        <div class="cart-item" id="cartItem-${index}">
                            <input type="checkbox" 
                                   class="cart-item-checkbox" 
                                   id="checkbox-${index}"
                                   onchange="toggleItemSelection(${index})">
                            <img src="${image}" class="cart-item-image" alt="${name}">
                                <div class="cart-item-info">
                                    <div class="cart-item-name">${name}</div>
                                    <div class="cart-item-variant">${color} / ${size}</div>
                                    <div class="cart-item-price">
                                        <div class="quantity-selector" style="margin: 0.5rem 0; gap: 0.5rem;">
                                            <button class="quantity-btn" style="width: 25px; height: 25px; font-size: 1rem; padding: 0;" onclick="updateCartQuantity(${index}, -1)">-</button>
                                            <span class="quantity-display" style="font-size: 1rem; min-width: 20px;">${q}</span>
                                            <button class="quantity-btn" style="width: 25px; height: 25px; font-size: 1rem; padding: 0;" onclick="updateCartQuantity(${index}, 1)">+</button>
                                        </div>
                                        RM${price.toFixed(2)} (Sub: RM${subtotal.toFixed(2)})
                                    </div>
                                </div>
                            <button class="cart-item-remove" onclick="removeFromCart(${index})">Remove</button>
                        </div>
                    `;
                            }).join('');

                            document.getElementById('cartTotal').textContent = `RM${total.toFixed(2)}`;
                            document.getElementById('cartTotalSection').style.display = 'block';

                            updateSelectionInfo();
                        }

                        modal.style.display = 'block';
                    }

                    function toggleItemSelection(index) {
                        const checkbox = document.getElementById(`checkbox-${index}`);
                        const cartItem = document.getElementById(`cartItem-${index}`);

                        if (checkbox.checked) {
                            selectedItems.add(index);
                            cartItem.classList.add('selected');
                        } else {
                            selectedItems.delete(index);
                            cartItem.classList.remove('selected');
                        }

                        updateSelectionInfo();
                        updateSelectAllCheckbox();
                    }

                    function toggleSelectAll() {
                        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                        const allCheckboxes = document.querySelectorAll('.cart-item-checkbox');

                        if (selectAllCheckbox.checked) {
                            allCheckboxes.forEach((checkbox, index) => {
                                checkbox.checked = true;
                                selectedItems.add(index);
                                document.getElementById(`cartItem-${index}`).classList.add('selected');
                            });
                        } else {
                            allCheckboxes.forEach((checkbox, index) => {
                                checkbox.checked = false;
                                selectedItems.delete(index);
                                document.getElementById(`cartItem-${index}`).classList.remove('selected');
                            });
                        }

                        updateSelectionInfo();
                    }

                    function updateSelectAllCheckbox() {
                        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                        const totalItems = cart.length;
                        const selectedCount = selectedItems.size;

                        if (totalItems === 0) { // If cart is empty, disable and uncheck
                            selectAllCheckbox.checked = false;
                            selectAllCheckbox.indeterminate = false;
                            selectAllCheckbox.disabled = true;
                        } else if (selectedCount === 0) {
                            selectAllCheckbox.checked = false;
                            selectAllCheckbox.indeterminate = false;
                            selectAllCheckbox.disabled = false;
                        } else if (selectedCount === totalItems) {
                            selectAllCheckbox.checked = true;
                            selectAllCheckbox.indeterminate = false;
                            selectAllCheckbox.disabled = false;
                        } else {
                            selectAllCheckbox.checked = false;
                            selectAllCheckbox.indeterminate = true;
                            selectAllCheckbox.disabled = false;
                        }
                    }

                    function updateSelectionInfo() {
                        const selectedCount = selectedItems.size;
                        const totalItems = cart.length;

                        document.getElementById('selectionInfo').textContent =
                            `${selectedCount} of ${totalItems} items selected`;

                        let selectedTotal = 0;
                        selectedItems.forEach(index => {
                            if (cart[index]) {
                                const item = cart[index];
                                selectedTotal += (item.price || 0) * (item.quantity || 1);
                            }
                        });

                        if (selectedCount > 0) {
                            document.getElementById('selectedTotal').textContent = `RM${selectedTotal.toFixed(2)}`;
                            document.getElementById('selectedTotalSection').style.display = 'block';
                            document.getElementById('removeSelectedBtn').disabled = false;
                            document.getElementById('checkoutSelectedBtn').disabled = false;
                        } else {
                            document.getElementById('selectedTotalSection').style.display = 'none';
                            document.getElementById('removeSelectedBtn').disabled = true;
                            document.getElementById('checkoutSelectedBtn').disabled = true;
                        }
                    }

                    function removeSelected() {
                        if (selectedItems.size === 0) return;
                        if (!confirm('Remove selected items?')) return;

                        const sortedIndices = Array.from(selectedItems).sort((a, b) => b - a);
                        sortedIndices.forEach(index => {
                            cart.splice(index, 1);
                        });

                        localStorage.setItem('benzgifts_cart', JSON.stringify(cart));
                        if (currentUser) saveCartToDB();

                        selectedItems.clear();
                        openCart();
                        updateCartBadge();
                    }

                    function checkoutSelected() {
                        if (!currentUser) {
                            openAuthModal();
                            return;
                        }
                        if (selectedItems.size === 0) return;

                        const selectedCartItems = Array.from(selectedItems)
                            .map(index => cart[index])
                            .filter(item => item !== undefined);

                        localStorage.setItem('benzgifts_checkout_items', JSON.stringify(selectedCartItems));
                        window.location.href = 'checkout.html?selected=true';
                    }

                    function removeFromCart(index) {
                        cart.splice(index, 1);
                        localStorage.setItem('benzgifts_cart', JSON.stringify(cart));
                        if (currentUser) saveCartToDB();
                        openCart();
                        updateCartBadge();
                    }

                    async function updateCartQuantity(index, delta) {
                        if (!cart[index]) return;

                        cart[index].quantity += delta;

                        if (cart[index].quantity <= 0) {
                            if (confirm('Remove item from cart?')) {
                                cart.splice(index, 1);
                            } else {
                                cart[index].quantity = 1;
                            }
                        }

                        localStorage.setItem('benzgifts_cart', JSON.stringify(cart));
                        if (currentUser) await saveCartToDB();

                        openCart();
                        updateCartBadge();
                    }

                    // Standard Add to Cart (Restored)
                    window.addToCart = function () {
                        if (!currentProduct) return;

                        const colorSelect = document.getElementById('colorSelect');
                        const sizeSelect = document.getElementById('sizeSelect');

                        if (!colorSelect || !sizeSelect) return;

                        const color = colorSelect.value;
                        const size = sizeSelect.value;

                        if (!color || !size) {
                            showError('Please select Shirt Color and Size first');
                            return;
                        }

                        const variant = currentProduct.variants.find(v => v.color === color && v.size === size);
                        if (!variant) {
                            showError('Selected variant not found or out of stock');
                            return;
                        }

                        const qty = typeof quantity !== 'undefined' ? quantity : parseInt(document.getElementById('quantity').textContent);

                        cart = JSON.parse(localStorage.getItem('benzgifts_cart') || '[]');
                        if (!Array.isArray(cart)) cart = [];

                        // Simple Cart Item
                        const cartItem = {
                            product_id: currentProduct.id,
                            name: currentProduct.name,
                            image: document.querySelector('.color-swatch.active img') ? document.querySelector('.color-swatch.active img').src : currentProduct.image,
                            color: color,
                            size: size,
                            price: variant.price,
                            quantity: qty
                        };

                        // Check for duplicate (non-customized)
                        const existingIndex = cart.findIndex(item =>
                            item.product_id === cartItem.product_id &&
                            item.color === cartItem.color &&
                            item.size === cartItem.size &&
                            !item.customization
                        );

                        if (existingIndex !== -1) {
                            cart[existingIndex].quantity += qty;
                        } else {
                            cart.push(cartItem);
                        }

                        localStorage.setItem('benzgifts_cart', JSON.stringify(cart));
                        if (currentUser) saveCartToDB();

                        showSuccess('‚úÖ Added to cart! Proceed to Checkout to customize.');
                        updateCartBadge();
                        closeCart();
                    };

                    // Initialize
                    document.addEventListener('DOMContentLoaded', () => {
                        // Removed updateCalculator() call
                    });

                </script>
</body>

</html>