<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Benzgifts</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Add all your CSS styles here - Copy them from your previous product.html */
        body { font-family: sans-serif; }
        .container { max-width: 1200px; margin: auto; padding: 1rem; }
        .loading-spinner { text-align: center; padding: 2rem; }
        .error-message { color: red; text-align: center; padding: 2rem; }
        .product-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        /* Add ALL your other styles */
    </style>
</head>
<body>
    <header class="header">
         <nav class="nav">
            <div class="logo" onclick="window.location.href='/'">BenzGifts</div>
            </nav>
    </header>

    <div class="container">
        <div class="breadcrumb">
            <a href="/">Home</a> / <a href="/#shop">Products</a> / <span id="breadcrumbProduct">Loading...</span>
        </div>

        <div id="loadingSpinner" class="loading-spinner">Loading...</div>
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div class="product-container" id="productContainer" style="display: none;">
             <div class="product-gallery">
                 <img class="main-image" id="mainImage" src="" alt="Product Image">
                 <div class="thumbnail-list" id="thumbnailList"></div>
             </div>
             <div class="product-info">
                 <h1 class="product-title" id="productName">Loading...</h1>
                 <div class="product-price" id="productPrice">RM0.00</div>
                 <div class="selection-group">
                     <label class="selection-label">Color</label>
                     <div class="color-options" id="colorOptions"></div>
                 </div>
                 <div class="selection-group">
                      <label class="selection-label">Size</label>
                      <div class="size-options" id="sizeOptions"></div>
                 </div>
                 <div class="selection-group">
                     <label class="selection-label">Quantity</label>
                     <div class="quantity-selector">
                         <div class="quantity-control">
                             <button class="quantity-btn" onclick="changeQuantity(-1)">-</button>
                             <input type="number" class="quantity-input" id="quantity" value="1" min="1" readonly>
                             <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
                         </div>
                         <span class="stock-info" id="stockInfo">Select color and size</span>
                     </div>
                 </div>
                  <div class="action-buttons">
                     <button class="btn btn-cart" id="addToCartBtn" onclick="addToCart()" disabled>Add to Cart</button>
                     <button class="btn btn-buy" id="buyNowBtn" onclick="buyNow()" disabled>Buy Now</button>
                 </div>
             </div>
        </div>
        <div class="product-details" id="productDetails" style="display: none;">
             <div class="tabs">
                 <div class="tab active" onclick="switchTab(0)">Description</div>
                 <div class="tab" onclick="switchTab(1)">Specifications</div>
             </div>
             <div class="tab-content active" id="tab-description">
                  <p id="productDescription">Loading...</p>
             </div>
              <div class="tab-content" id="tab-specifications">
                  <ul class="specs-list" id="productSpecs"><li>Loading...</li></ul>
              </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://oomvdejocpdtqcmeacii.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vbXZkZWpvY3BkdHFjbWVhY2lpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MzA1NjksImV4cCI6MjA3NTUwNjU2OX0.0P_dEqRlvSUVJiCF_F0mboSenqvbp64ZV9islyvcF_E';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentProduct = null;
        let selectedColor = null;
        let selectedSize = null;
        // Add other necessary variables (currentUser, cart)

        // --- THIS IS THE CORRECTED loadProduct FUNCTION ---
        async function loadProduct() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const productContainer = document.getElementById('productContainer');
            const errorContainer = document.getElementById('errorMessage');

            loadingSpinner.style.display = 'block';
            productContainer.style.display = 'none';
            errorContainer.style.display = 'none';


            if (!productId) {
                showError('No product ID provided');
                return;
            }

            try {
                // Correct Supabase client usage
                const { data: products, error } = await supabaseClient
                    .from('products')
                    .select('*')
                    .eq('id', productId);

                if (error) throw error;

                if (products && products.length > 0) {
                    currentProduct = products[0];
                    displayProduct();
                    hideLoading();
                } else {
                    showError('Product not found');
                }
            } catch (error) {
                console.error('Error loading product:', error);
                // Check if it's a network error explicitly
                if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                     showError(`Network error loading product. Is Supabase paused? Details: ${error.message}`);
                } else {
                     showError(`Error loading product: ${error.message}. Check RLS policies.`);
                }
            }
        }
        // --- END CORRECTED loadProduct ---


        function hideLoading() {
             document.getElementById('loadingSpinner').style.display = 'none';
             document.getElementById('productContainer').style.display = 'grid'; // Use grid or flex as needed
             document.getElementById('productDetails').style.display = 'block';
        }

        function showError(message) {
             document.getElementById('loadingSpinner').style.display = 'none';
             const errorContainer = document.getElementById('errorMessage');
             errorContainer.innerHTML = `<h2>Error</h2><p>${message}</p><button onclick="window.location.href='/'">Back to Home</button>`;
             errorContainer.style.display = 'block';
        }

        function getColorHex(colorName) { /* ... Your color map ... */ return '#ccc'; }

        function displayProduct() {
             // --- THIS IS THE CORRECTED displayProduct FUNCTION ---
             if (!currentProduct) return;

             document.getElementById('breadcrumbProduct').textContent = currentProduct.name || 'Product';
             document.getElementById('productName').textContent = currentProduct.name || 'Unnamed Product';

             let priceValue = null;
             if (currentProduct.price_range) {
                  priceValue = currentProduct.price_range;
             } else if (typeof currentProduct.price === 'number' && currentProduct.price >= 0) { // Allow 0 price
                 priceValue = `RM${currentProduct.price.toFixed(2)}`;
             } else if (currentProduct.variants && Array.isArray(currentProduct.variants) && currentProduct.variants.length > 0) {
                 const firstVariantPrice = currentProduct.variants[0]?.price;
                 if (typeof firstVariantPrice === 'number' && firstVariantPrice >= 0) {
                      priceValue = `RM${firstVariantPrice.toFixed(2)}`;
                 }
             }
             document.getElementById('productPrice').textContent = priceValue !== null ? priceValue : 'Price unavailable';

             document.getElementById('productDescription').textContent = currentProduct.description || 'No description available.';

             const mainImage = document.getElementById('mainImage');
             const colorData = Array.isArray(currentProduct.colors) ? currentProduct.colors : [];
             mainImage.src = colorData[0]?.image || 'https://via.placeholder.com/500?text=No+Image';

             const thumbnailList = document.getElementById('thumbnailList');
             thumbnailList.innerHTML = colorData.map((color, index) => `
                 <img class="thumbnail ${index === 0 ? 'active' : ''}"
                      src="${color.image || ''}"
                      alt="${color.name || ''} thumbnail"
                      onclick="changeMainImage('${color.image || ''}', this)">
             `).join('');

             const colorOptions = document.getElementById('colorOptions');
             colorOptions.innerHTML = colorData.map(color => `
                 <div class="color-option"
                      style="background-color: ${getColorHex(color.name || '')};"
                      title="${color.name || ''}"
                      onclick="selectColor('${color.name || ''}', this, '${color.image || ''}')"></div>
             `).join('');

             const sizeOptions = document.getElementById('sizeOptions');
             const sizeData = Array.isArray(currentProduct.sizes) ? currentProduct.sizes : [];
             sizeOptions.innerHTML = sizeData.map(size => `
                 <div class="size-option" onclick="selectSize('${size}', this)">${size}</div>
             `).join('');

             const productSpecs = document.getElementById('productSpecs');
             const specData = Array.isArray(currentProduct.specifications) ? currentProduct.specifications : [];
             productSpecs.innerHTML = specData.length > 0
                 ? specData.map(spec => `<li>${spec || ''}</li>`).join('')
                 : '<li>No specifications available.</li>';
              // --- END CORRECTED displayProduct ---
        }


        // Add ALL your other functions here:
        // changeMainImage, selectColor, selectSize, checkSelections,
        // changeQuantity, addToCart, buyNow, updateCartBadge,
        // openCart, closeCart, removeFromCart, proceedToCheckout,
        // switchTab, handleAuth, checkAuth etc.

        document.addEventListener('DOMContentLoaded', () => {
            loadProduct();
            // updateCartBadge(); // Make sure this function exists
            // checkAuth(); // Make sure this function exists
        });

    </script>

</body>
</html>
